<!DOCTYPE html>

<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SonParaBot</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080808;
  --bg2: #0f0f0f;
  --bg3: #161616;
  --green: #00e87a;
  --red: #ff2d55;
  --yellow: #ffd60a;
  --orange: #ff6b1a;
  --blue: #0a84ff;
  --text: #f0f0f0;
  --dim: #444;
  --dim2: #2a2a2a;
}

- { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
background: var(â€“bg);
color: var(â€“text);
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 13px;
min-height: 100vh;
overflow-x: hidden;
}

/* SCANLINES */
body::after {
content: â€˜â€™;
position: fixed;
inset: 0;
background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.06) 2px, rgba(0,0,0,0.06) 4px);
pointer-events: none;
z-index: 9999;
}

/* HEADER */
header {
position: sticky; top: 0; z-index: 200;
background: rgba(8,8,8,0.96);
backdrop-filter: blur(10px);
border-bottom: 1px solid #1a1a1a;
padding: 10px 14px;
display: flex;
align-items: center;
justify-content: space-between;
}

.logo {
font-family: â€˜Bebas Neueâ€™;
font-size: 20px;
letter-spacing: 3px;
color: var(â€“yellow);
}
.logo em { color: var(â€“red); font-style: normal; }

.hdr-right { display: flex; align-items: center; gap: 8px; }

.dot {
width: 7px; height: 7px;
border-radius: 50%;
background: var(â€“dim);
transition: all 0.3s;
}
.dot.on { background: var(â€“green); box-shadow: 0 0 8px var(â€“green); animation: blink 2s infinite; }
.dot.err { background: var(â€“red); box-shadow: 0 0 8px var(â€“red); }

@keyframes blink { 0%,100%{opacity:1}50%{opacity:.4} }

.net-badge {
font-size: 9px; font-weight: 700; letter-spacing: 1px;
padding: 2px 7px; border-radius: 10px;
border: 1px solid var(â€“dim2);
color: var(â€“dim);
}
.net-badge.testnet { border-color: rgba(255,107,26,.4); color: var(â€“orange); }
.net-badge.live { border-color: rgba(255,45,85,.4); color: var(â€“red); }

/* PAGES */
.page { display: none; padding: 12px 14px; max-width: 480px; margin: 0 auto; padding-bottom: 80px; }
.page.active { display: block; }

/* TOAST */
#toast {
position: fixed; top: 64px; left: 50%;
transform: translateX(-50%) translateY(-8px);
background: #1c1c1c;
font-size: 12px; padding: 8px 18px; border-radius: 20px;
opacity: 0; transition: all .25s; z-index: 9998;
white-space: nowrap; max-width: 90vw;
}
#toast.ok  { border: 1px solid var(â€“green); color: var(â€“green); }
#toast.err { border: 1px solid var(â€“red); color: var(â€“red); }
#toast.info{ border: 1px solid var(â€“yellow); color: var(â€“yellow); }
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* CARDS */
.card {
background: var(â€“bg2);
border: 1px solid #1c1c1c;
border-radius: 12px;
margin-bottom: 10px;
}

.card-hdr {
padding: 10px 14px;
border-bottom: 1px solid #191919;
font-size: 10px; color: var(â€“dim); text-transform: uppercase; letter-spacing: 1.5px;
display: flex; justify-content: space-between; align-items: center;
}

.card-body { padding: 14px; }

/* BALANCE */
.balance-num {
font-family: â€˜Bebas Neueâ€™;
font-size: 46px;
line-height: 1;
letter-spacing: 1px;
color: var(â€“yellow);
transition: color .3s;
}
.balance-num.danger { color: var(â€“red); animation: jitter .4s infinite; }
@keyframes jitter { 0%,100%{transform:translateX(0)} 33%{transform:translateX(-2px)} 66%{transform:translateX(2px)} }

.pnl-row { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
.pnl { font-size: 12px; }
.pnl.up { color: var(â€“green); }
.pnl.dn { color: var(â€“red); }

/* RISK BAR */
.risk-bar { height: 4px; background: var(â€“bg3); border-radius: 2px; margin: 8px 0; overflow: hidden; }
.risk-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(â€“green) 0%, var(â€“yellow) 50%, var(â€“orange) 75%, var(â€“red) 100%); transition: width .5s; }

/* STATS */
.stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
.stat { background: var(â€“bg2); border: 1px solid #1c1c1c; border-radius: 10px; padding: 10px; text-align: center; }
.stat-v { font-family: â€˜Bebas Neueâ€™; font-size: 22px; line-height: 1; }
.stat-v.g { color: var(â€“green); }
.stat-v.r { color: var(â€“red); }
.stat-v.y { color: var(â€“yellow); }
.stat-l { font-size: 9px; color: var(â€“dim); text-transform: uppercase; letter-spacing: 1px; margin-top: 3px; }

/* PRICE */
.price-row { display: flex; justify-content: space-between; align-items: baseline; padding: 6px 0; }
.price-val { font-family: â€˜Bebas Neueâ€™; font-size: 20px; color: var(â€“text); }
.price-sub { font-size: 10px; color: var(â€“dim); }

/* GRID LEVELS */
.grid-level {
display: flex; align-items: center; gap: 8px;
padding: 8px 0; border-bottom: 1px solid #161616;
}
.grid-level:last-child { border: none; }
.gl-badge {
font-size: 10px; font-family: â€˜Bebas Neueâ€™; letter-spacing: 1px;
padding: 2px 7px; border-radius: 4px; flex-shrink: 0;
}
.gl-badge.buy { background: rgba(0,232,122,.1); color: var(â€“green); border: 1px solid rgba(0,232,122,.3); }
.gl-badge.sell { background: rgba(255,45,85,.1); color: var(â€“red); border: 1px solid rgba(255,45,85,.3); }
.gl-price { flex: 1; font-size: 12px; }
.gl-status { font-size: 10px; color: var(â€“dim); }

/* ACTION BUTTONS */
.btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }

.btn {
padding: 15px;
border: none; border-radius: 10px;
font-family: â€˜Bebas Neueâ€™; font-size: 18px; letter-spacing: 2px;
cursor: pointer; transition: all .15s; outline: none;
position: relative; overflow: hidden;
}

.btn:active { transform: scale(0.96); }

.btn-go {
background: #001a0e;
color: var(â€“green);
border: 1px solid rgba(0,232,122,.5);
}
.btn-go.running { animation: runPulse 1.5s infinite; }
@keyframes runPulse { 0%,100%{box-shadow:0 0 8px rgba(0,232,122,.2)} 50%{box-shadow:0 0 20px rgba(0,232,122,.5)} }

.btn-stop {
background: #1a0007;
color: var(â€“red);
border: 1px solid rgba(255,45,85,.5);
}

/* TRADES */
.trade-item {
display: flex; align-items: center; gap: 10px;
padding: 10px 14px; border-bottom: 1px solid #141414;
animation: slideIn .25s ease;
}
.trade-item:last-child { border: none; }
@keyframes slideIn { from{transform:translateX(-15px);opacity:0} to{transform:translateX(0);opacity:1} }

.t-side {
width: 30px; height: 30px; border-radius: 6px;
display: flex; align-items: center; justify-content: center;
font-family: â€˜Bebas Neueâ€™; font-size: 11px; flex-shrink: 0;
}
.t-side.buy { background: rgba(0,232,122,.1); color: var(â€“green); border: 1px solid rgba(0,232,122,.3); }
.t-side.sell { background: rgba(255,45,85,.1); color: var(â€“red); border: 1px solid rgba(255,45,85,.3); }

.t-info { flex: 1; }
.t-pair { font-size: 12px; font-weight: 700; }
.t-meta { font-size: 10px; color: var(â€“dim); margin-top: 2px; }

.t-pnl { text-align: right; }
.t-amount { font-family: â€˜Bebas Neueâ€™; font-size: 15px; }
.t-amount.pos { color: var(â€“green); }
.t-amount.neg { color: var(â€“red); }

/* LOG */
.log-body {
padding: 10px 14px; height: 160px; overflow-y: auto;
font-family: â€˜Share Tech Monoâ€™, monospace; font-size: 11px; line-height: 2;
}
.le { display: flex; gap: 8px; }
.lt { color: var(â€“dim); flex-shrink: 0; }
.lm.ok   { color: var(â€“green); }
.lm.err  { color: var(â€“red); }
.lm.warn { color: var(â€“yellow); }
.lm.info { color: #3a9bff; }
.lm.panic { color: var(â€“red); animation: blink .4s infinite; }

/* FORM ELEMENTS */
label { font-size: 10px; color: var(â€“dim); text-transform: uppercase; letter-spacing: 1px; display: block; margin-bottom: 5px; }

input[type=â€œtextâ€],
input[type=â€œpasswordâ€],
input[type=â€œnumberâ€],
select {
width: 100%;
background: var(â€“bg3);
border: 1px solid #252525;
border-radius: 7px;
color: var(â€“text);
font-family: â€˜IBM Plex Monoâ€™, monospace;
font-size: 13px;
padding: 9px 11px;
outline: none;
-webkit-appearance: none;
margin-bottom: 12px;
}
input:focus, select:focus { border-color: rgba(255,214,10,.5); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* LEVERAGE SLIDER */
.lev-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.lev-num { font-family: â€˜Bebas Neueâ€™; font-size: 26px; color: var(â€“orange); }

input[type=â€œrangeâ€] {
width: 100%; -webkit-appearance: none;
height: 4px; border-radius: 2px; background: #222; outline: none; margin-bottom: 4px;
}
input[type=â€œrangeâ€]::-webkit-slider-thumb {
-webkit-appearance: none;
width: 18px; height: 18px; border-radius: 50%;
background: var(â€“orange);
box-shadow: 0 0 8px rgba(255,107,26,.7);
cursor: pointer;
}

.slider-marks { display: flex; justify-content: space-between; font-size: 9px; color: var(â€“dim); }

/* TOGGLE */
.toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #181818; }
.toggle-row:last-child { border: none; }
.tl { font-size: 12px; }
.ts { font-size: 10px; color: var(â€“dim); margin-top: 2px; }
.toggle { width: 40px; height: 22px; background: #1e1e1e; border: 1px solid #2a2a2a; border-radius: 11px; position: relative; cursor: pointer; transition: all .3s; flex-shrink: 0; }
.toggle.on { background: rgba(0,232,122,.15); border-color: var(â€“green); }
.toggle::after { content: â€˜â€™; position: absolute; width: 15px; height: 15px; border-radius: 50%; background: #333; top: 3px; left: 3px; transition: all .3s; }
.toggle.on::after { transform: translateX(18px); background: var(â€“green); box-shadow: 0 0 6px var(â€“green); }

/* BOTTOM NAV */
.bnav {
position: fixed; bottom: 0; left: 0; right: 0;
background: rgba(8,8,8,.96); backdrop-filter: blur(10px);
border-top: 1px solid #181818;
display: flex; z-index: 200;
padding-bottom: env(safe-area-inset-bottom);
}
.ni { flex: 1; text-align: center; padding: 8px 0; cursor: pointer; transition: all .2s; }
.ni-icon { font-size: 18px; display: block; }
.ni-lbl { font-size: 9px; color: var(â€“dim); display: block; margin-top: 2px; letter-spacing: .5px; text-transform: uppercase; }
.ni.active .ni-lbl { color: var(â€“yellow); }

/* SECTION TITLE */
.sec-title { font-size: 10px; color: var(â€“dim); text-transform: uppercase; letter-spacing: 1.5px; margin: 14px 0 8px; }

.submit-btn {
width: 100%;
padding: 13px;
background: rgba(255,214,10,.08);
border: 1px solid rgba(255,214,10,.4);
border-radius: 8px;
color: var(â€“yellow);
font-family: â€˜Bebas Neueâ€™; font-size: 17px; letter-spacing: 2px;
cursor: pointer; transition: all .2s; margin-top: 4px;
}
.submit-btn:active { background: rgba(255,214,10,.15); }

.danger-btn {
width: 100%;
padding: 13px;
background: rgba(255,45,85,.08);
border: 1px solid rgba(255,45,85,.4);
border-radius: 8px;
color: var(â€“red);
font-family: â€˜Bebas Neueâ€™; font-size: 17px; letter-spacing: 2px;
cursor: pointer; transition: all .2s; margin-top: 8px;
}

.conn-status {
padding: 10px 14px; border-radius: 8px; font-size: 11px;
display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
}
.conn-status.ok { background: rgba(0,232,122,.06); border: 1px solid rgba(0,232,122,.2); color: var(â€“green); }
.conn-status.fail { background: rgba(255,45,85,.06); border: 1px solid rgba(255,45,85,.2); color: var(â€“red); }
.conn-status.wait { background: rgba(255,214,10,.06); border: 1px solid rgba(255,214,10,.2); color: var(â€“yellow); }

.server-url-hint { font-size: 10px; color: var(â€“dim); margin-bottom: 12px; padding: 8px 10px; background: var(â€“bg3); border-radius: 6px; }
</style>

</head>
<body>

<div id="toast" class="toast"></div>

<header>
  <div class="logo">SON<em>PARA</em>BOT</div>
  <div class="hdr-right">
    <span class="net-badge" id="netBadge">DEMO</span>
    <span class="dot" id="statusDot"></span>
  </div>
</header>

<!-- â”€â”€ PAGE: BOT â”€â”€ -->

<div class="page active" id="page-bot">

  <div class="card" style="margin-bottom:10px">
    <div class="card-body">
      <div style="font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px">Bakiye (USDT)</div>
      <div class="balance-num" id="balanceNum">â€”</div>
      <div class="pnl-row">
        <span class="pnl" id="pnlDisplay">â€”</span>
        <span style="font-size:10px;color:var(--dim)" id="lastUpdate">â€”</span>
      </div>
      <div class="risk-bar"><div class="risk-fill" id="riskFill" style="width:20%"></div></div>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--dim)">
        <span id="symbolDisplay">â€”</span>
        <span id="priceDisplay">â€”</span>
      </div>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat"><div class="stat-v g" id="winsDisplay">â€”</div><div class="stat-l">Kazanan</div></div>
    <div class="stat"><div class="stat-v r" id="lossesDisplay">â€”</div><div class="stat-l">Kaybeden</div></div>
    <div class="stat"><div class="stat-v y" id="wrDisplay">â€”</div><div class="stat-l">Win Rate</div></div>
  </div>

  <div class="btn-row">
    <button class="btn btn-go" id="startBtn" onclick="handleStart()">BAÅLAT</button>
    <button class="btn btn-stop" onclick="handleEmergency()">ACÄ°L DUR</button>
  </div>

  <div class="card">
    <div class="card-hdr">
      Grid Seviyeleri
      <span style="font-size:10px;background:rgba(255,214,10,.08);color:var(--yellow);padding:2px 8px;border-radius:10px;border:1px solid rgba(255,214,10,.2)" id="gridCount">0 emir</span>
    </div>
    <div id="gridLevels" style="padding:0 14px;max-height:200px;overflow-y:auto">
      <div style="padding:14px 0;text-align:center;color:var(--dim);font-size:11px">Bot baÅŸlatÄ±ldÄ±ÄŸÄ±nda grid emirleri burada gÃ¶rÃ¼nÃ¼r</div>
    </div>
  </div>

  <div class="card">
    <div class="card-hdr">Son Ä°ÅŸlemler</div>
    <div id="tradeList">
      <div style="padding:14px;text-align:center;color:var(--dim);font-size:11px">HenÃ¼z iÅŸlem yok</div>
    </div>
  </div>

  <div class="card">
    <div class="card-hdr">Bot Logu</div>
    <div class="log-body" id="logBody"></div>
  </div>

</div>

<!-- â”€â”€ PAGE: AYARLAR â”€â”€ -->

<div class="page" id="page-settings">

  <div class="sec-title">Grid AyarlarÄ±</div>
  <div class="card">
    <div class="card-body">
      <div class="form-row">
        <div>
          <label>Coin</label>
          <select id="cfg-symbol">
            <option value="BTCUSDT">BTC/USDT</option>
            <option value="ETHUSDT">ETH/USDT</option>
            <option value="SOLUSDT">SOL/USDT</option>
            <option value="BNBUSDT">BNB/USDT</option>
            <option value="DOGEUSDT">DOGE/USDT</option>
          </select>
        </div>
        <div>
          <label>USDT MiktarÄ±</label>
          <input type="number" id="cfg-usdt" value="100" min="10" />
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Grid Seviyesi</label>
          <input type="number" id="cfg-levels" value="5" min="2" max="20" />
        </div>
        <div>
          <label>AralÄ±k (%)</label>
          <input type="number" id="cfg-spacing" value="0.5" step="0.1" min="0.1" max="5" />
        </div>
      </div>

```
  <div>
    <div class="lev-header">
      <label style="margin:0">KaldÄ±raÃ§</label>
      <div class="lev-num"><span id="levNum">3</span>x</div>
    </div>
    <input type="range" id="cfg-leverage" min="1" max="20" value="3"
      oninput="document.getElementById('levNum').textContent=this.value" />
    <div class="slider-marks">
      <span>1x</span><span>5x</span><span>10x</span><span>15x</span><span>20x</span>
    </div>
  </div>
</div>
```

  </div>

  <div class="sec-title">Risk YÃ¶netimi</div>
  <div class="card">
    <div class="card-body">
      <div class="form-row">
        <div>
          <label>Stop Loss (%)</label>
          <input type="number" id="cfg-sl" value="10" min="1" max="90" />
        </div>
        <div>
          <label>Take Profit (%)</label>
          <input type="number" id="cfg-tp" value="20" min="1" max="500" />
        </div>
      </div>
    </div>
  </div>

<button class="submit-btn" onclick="saveConfig()">ğŸ’¾ AYARLARI KAYDET</button>

  <div class="sec-title">Sunucu BaÄŸlantÄ±sÄ±</div>
  <div class="conn-status wait" id="connStatus">
    <span>âš¡</span><span id="connText">Bot sunucusuna baÄŸlanÄ±lÄ±yor...</span>
  </div>
  <div class="server-url-hint" id="serverUrlHint">
    Sunucu URL: <span id="serverUrlDisplay">â€”</span><br>
    <span style="color:var(--dim)">Bu URL Railway'den otomatik alÄ±nÄ±r</span>
  </div>

  <div class="sec-title">Binance API (Sunucuda .env dosyasÄ±na yaz)</div>
  <div class="card">
    <div class="card-body">
      <div class="toggle-row">
        <div><div class="tl">Testnet Modu</div><div class="ts">GerÃ§ek para kullanma</div></div>
        <div class="toggle on" id="testnetToggle" onclick="this.classList.toggle('on')"></div>
      </div>
      <div style="padding:10px 0;font-size:11px;color:var(--dim);line-height:1.8">
        API anahtarlarÄ± gÃ¼venlik iÃ§in sunucuda .env dosyasÄ±na yazÄ±lÄ±r.<br>
        Railway â†’ Variables bÃ¶lÃ¼mÃ¼nden ekle:<br>
        <span style="color:var(--yellow)">BINANCE_API_KEY=...</span><br>
        <span style="color:var(--yellow)">BINANCE_API_SECRET=...</span><br>
        <span style="color:var(--yellow)">TESTNET=false</span>
      </div>
    </div>
  </div>

</div>

<!-- â”€â”€ PAGE: KURULUM â”€â”€ -->

<div class="page" id="page-setup">
  <div class="sec-title">ğŸš€ Kurulum Rehberi</div>

  <div class="card" style="margin-bottom:10px">
    <div class="card-hdr">1. GitHub'a YÃ¼kle</div>
    <div class="card-body" style="font-size:11px;line-height:2;color:#ccc">
      <div>â‘  github.com â†’ Yeni repo oluÅŸtur</div>
      <div>â‘¡ bot.py, server.py, index.html, requirements.txt yÃ¼kle</div>
      <div>â‘¢ Repoyu public yap</div>
    </div>
  </div>

  <div class="card" style="margin-bottom:10px">
    <div class="card-hdr">2. Railway'e Deploy Et</div>
    <div class="card-body" style="font-size:11px;line-height:2;color:#ccc">
      <div>â‘  railway.app â†’ GitHub ile giriÅŸ</div>
      <div>â‘¡ New Project â†’ Deploy from GitHub</div>
      <div>â‘¢ Repoyu seÃ§ â†’ Deploy</div>
      <div>â‘£ Variables ekle:</div>
      <div style="background:var(--bg3);padding:8px 10px;border-radius:6px;margin:6px 0;color:var(--yellow)">
        BINANCE_API_KEY = senin_key<br>
        BINANCE_API_SECRET = senin_secret<br>
        TESTNET = true<br>
        SYMBOL = BTCUSDT
      </div>
      <div>â‘¤ Settings â†’ Domains â†’ Subdomain al</div>
    </div>
  </div>

  <div class="card" style="margin-bottom:10px">
    <div class="card-hdr">3. Telefona BaÄŸlan</div>
    <div class="card-body" style="font-size:11px;line-height:2;color:#ccc">
      <div>â‘  Railway'den aldÄ±ÄŸÄ±n URL'i aÅŸaÄŸÄ±ya yaz</div>
      <div>â‘¡ BaÄŸlan'a bas</div>
      <div>â‘¢ Ayarlar â†’ API key testnetinden al</div>
      <div>â‘£ Bot â†’ BaÅŸlat!</div>
      <br>
      <label>Sunucu URL</label>
      <input type="text" id="serverUrlInput" placeholder="https://sonpara.up.railway.app" />
      <button class="submit-btn" onclick="setServerUrl()">ğŸ”— BAÄLAN</button>
    </div>
  </div>

  <div class="card">
    <div class="card-hdr">âš ï¸ Ã–nemli UyarÄ±lar</div>
    <div class="card-body" style="font-size:11px;line-height:2">
      <div style="color:var(--red)">â€¢ Ä°lk 1-2 hafta mutlaka TESTNET kullan</div>
      <div style="color:var(--orange)">â€¢ KaldÄ±racÄ± 3x-5x'den fazla Ã§Ä±karma</div>
      <div style="color:var(--orange)">â€¢ Stop Loss daima aktif olsun</div>
      <div style="color:var(--yellow)">â€¢ Grid trading dÃ¼ÅŸÃ¼k volatilitede iyi Ã§alÄ±ÅŸÄ±r</div>
      <div style="color:var(--green)">â€¢ KÃ¼Ã§Ã¼k miktarla baÅŸla ($50-100)</div>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->

<nav class="bnav">
  <div class="ni active" id="ni-bot" onclick="goPage('bot')">
    <span class="ni-icon">ğŸ¤–</span><span class="ni-lbl">Bot</span>
  </div>
  <div class="ni" id="ni-settings" onclick="goPage('settings')">
    <span class="ni-icon">âš™ï¸</span><span class="ni-lbl">Ayarlar</span>
  </div>
  <div class="ni" id="ni-setup" onclick="goPage('setup')">
    <span class="ni-icon">ğŸ“‹</span><span class="ni-lbl">Kurulum</span>
  </div>
</nav>

<script>
// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let SERVER_URL = localStorage.getItem("serverUrl") || "";
let pollInterval = null;
let lastLogCount = 0;
let lastTradeCount = 0;
let isConnected = false;
let isRunning = false;

// â”€â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function goPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  document.getElementById('ni-' + name).classList.add('active');
}

// â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type}`;
  void t.offsetWidth;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}

// â”€â”€â”€ SERVER URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setServerUrl() {
  const url = document.getElementById('serverUrlInput').value.trim().replace(/\/$/, '');
  if (!url.startsWith('http')) { toast('GeÃ§ersiz URL!', 'err'); return; }
  SERVER_URL = url;
  localStorage.setItem('serverUrl', url);
  document.getElementById('serverUrlDisplay').textContent = url;
  document.getElementById('serverUrlInput').value = url;
  toast('Sunucu URL kaydedildi. BaÄŸlanÄ±lÄ±yor...', 'info');
  startPolling();
}

// â”€â”€â”€ API CALLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path, method = 'GET', body = null) {
  if (!SERVER_URL) return null;
  try {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) opts.body = JSON.stringify(body);
    const res = await fetch(SERVER_URL + path, opts);
    return await res.json();
  } catch (e) {
    return null;
  }
}

async function handleStart() {
  if (!SERVER_URL) { goPage('setup'); toast('Ã–nce sunucu URL gir!', 'err'); return; }
  
  const btn = document.getElementById('startBtn');
  
  if (isRunning) {
    // Durdur
    const r = await apiFetch('/api/stop', 'POST');
    if (r?.ok) { toast('Bot durduruldu', 'info'); }
    else toast('Hata!', 'err');
  } else {
    // BaÅŸlat - ayarlarÄ± gÃ¶nder
    const cfg = collectConfig();
    const r = await apiFetch('/api/start', 'POST', cfg);
    if (r?.ok) { toast('Bot baÅŸlatÄ±ldÄ±! âœ…', 'ok'); }
    else toast('BaÅŸlatma hatasÄ±!', 'err');
  }
}

async function handleEmergency() {
  if (!confirm('ACÄ°L DURUÅ! TÃ¼m pozisyonlar kapatÄ±lacak. Emin misin?')) return;
  const r = await apiFetch('/api/emergency', 'POST');
  if (r?.ok) { toast('ğŸš¨ ACÄ°L DURUÅ aktif!', 'err'); }
  else toast('Sunucu yanÄ±t vermedi', 'err');
}

function collectConfig() {
  return {
    symbol: document.getElementById('cfg-symbol').value,
    totalUsdt: parseFloat(document.getElementById('cfg-usdt').value),
    gridLevels: parseInt(document.getElementById('cfg-levels').value),
    gridSpacing: parseFloat(document.getElementById('cfg-spacing').value),
    leverage: parseInt(document.getElementById('cfg-leverage').value),
    stopLoss: parseFloat(document.getElementById('cfg-sl').value),
    takeProfit: parseFloat(document.getElementById('cfg-tp').value),
  };
}

async function saveConfig() {
  if (!SERVER_URL) { toast('Sunucu baÄŸlÄ± deÄŸil', 'err'); return; }
  const r = await apiFetch('/api/config', 'POST', collectConfig());
  if (r?.ok) toast('Ayarlar kaydedildi âœ…', 'ok');
  else toast('KayÄ±t hatasÄ±', 'err');
}

// â”€â”€â”€ STATE POLLING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function pollState() {
  const data = await apiFetch('/api/state');
  
  if (!data) {
    setConnected(false);
    return;
  }
  
  setConnected(true);
  renderState(data);
}

function setConnected(ok) {
  isConnected = ok;
  const dot = document.getElementById('statusDot');
  const connSt = document.getElementById('connStatus');
  const connTxt = document.getElementById('connText');
  
  if (ok) {
    dot.className = 'dot ' + (isRunning ? 'on' : '');
    connSt.className = 'conn-status ok';
    connTxt.textContent = 'Sunucuya baÄŸlandÄ± âœ“';
  } else {
    dot.className = 'dot err';
    connSt.className = 'conn-status fail';
    connTxt.textContent = 'Sunucuya ulaÅŸÄ±lamÄ±yor';
  }
}

function renderState(s) {
  isRunning = s.running;

  // Header
  const dot = document.getElementById('statusDot');
  dot.className = 'dot ' + (s.running ? 'on' : '');
  
  const netBadge = document.getElementById('netBadge');
  if (s.testnet) { netBadge.textContent = 'TESTNET'; netBadge.className = 'net-badge testnet'; }
  else { netBadge.textContent = 'LIVE'; netBadge.className = 'net-badge live'; }

  // Balance
  const bal = s.balance || 0;
  const balEl = document.getElementById('balanceNum');
  balEl.textContent = bal > 0 ? '$' + bal.toFixed(2) : 'â€”';
  balEl.className = 'balance-num' + (bal > 0 && bal < 50 ? ' danger' : '');

  // PnL
  const pnl = s.pnl || 0;
  const pnlPct = s.pnl_pct || 0;
  const pnlEl = document.getElementById('pnlDisplay');
  if (pnl > 0) {
    pnlEl.className = 'pnl up';
    pnlEl.textContent = `â–² +$${pnl.toFixed(2)} (+${pnlPct.toFixed(1)}%)`;
  } else if (pnl < 0) {
    pnlEl.className = 'pnl dn';
    pnlEl.textContent = `â–¼ -$${Math.abs(pnl).toFixed(2)} (${pnlPct.toFixed(1)}%)`;
  } else {
    pnlEl.className = 'pnl';
    pnlEl.textContent = '$0.00';
  }

  document.getElementById('lastUpdate').textContent = s.last_update || '';
  document.getElementById('symbolDisplay').textContent = s.symbol || 'â€”';
  document.getElementById('priceDisplay').textContent = s.current_price ? '$' + parseFloat(s.current_price).toLocaleString() : 'â€”';

  // Risk bar
  const risk = Math.min(100, Math.abs(pnlPct) * 5 + (s.leverage || 1) * 3);
  document.getElementById('riskFill').style.width = Math.max(5, risk) + '%';

  // Stats
  const total = (s.wins || 0) + (s.losses || 0);
  document.getElementById('winsDisplay').textContent = s.wins || 0;
  document.getElementById('lossesDisplay').textContent = s.losses || 0;
  document.getElementById('wrDisplay').textContent = total > 0 ? Math.round(s.wins/total*100) + '%' : 'â€”';

  // Start button
  const startBtn = document.getElementById('startBtn');
  startBtn.textContent = s.running ? 'Ã‡ALIÅIYOR' : 'BAÅLAT';
  if (s.running) startBtn.classList.add('running');
  else startBtn.classList.remove('running');

  // Grid levels
  const levels = s.grid_levels || [];
  document.getElementById('gridCount').textContent = levels.length + ' emir';
  if (levels.length > 0) {
    const sorted = [...levels].sort((a,b) => b.price - a.price);
    const midPrice = s.current_price || 0;
    document.getElementById('gridLevels').innerHTML = sorted.map(l => {
      const isBuy = l.price < midPrice;
      return `<div class="grid-level">
        <span class="gl-badge ${isBuy ? 'buy' : 'sell'}">${isBuy ? 'BUY' : 'SELL'}</span>
        <span class="gl-price">$${parseFloat(l.price).toLocaleString()}</span>
        <span class="gl-status">#${l.order_id?.toString().slice(-6)}</span>
      </div>`;
    }).join('');
  }

  // Trades
  const trades = s.trades || [];
  if (trades.length !== lastTradeCount) {
    lastTradeCount = trades.length;
    if (trades.length > 0) {
      document.getElementById('tradeList').innerHTML = trades.slice(0,10).map(t => {
        const isPos = t.pnl >= 0;
        return `<div class="trade-item">
          <div class="t-side ${t.side?.toLowerCase() === 'buy' ? 'buy' : 'sell'}">${t.side?.slice(0,1)}</div>
          <div class="t-info">
            <div class="t-pair">${t.symbol || s.symbol}</div>
            <div class="t-meta">${t.time} Â· $${parseFloat(t.price||0).toLocaleString()} Â· ${t.qty}</div>
          </div>
          <div class="t-pnl">
            <div class="t-amount ${isPos ? 'pos' : 'neg'}">${isPos?'+':'-'}$${Math.abs(t.pnl||0).toFixed(4)}</div>
          </div>
        </div>`;
      }).join('');
    }
  }

  // Logs
  const logs = s.logs || [];
  if (logs.length !== lastLogCount) {
    lastLogCount = logs.length;
    const body = document.getElementById('logBody');
    body.innerHTML = logs.slice(-60).map(l =>
      `<div class="le"><span class="lt">[${l.time}]</span><span class="lm ${l.level}">${l.msg}</span></div>`
    ).join('');
    body.scrollTop = body.scrollHeight;
  }
}

// â”€â”€â”€ POLLING START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startPolling() {
  if (pollInterval) clearInterval(pollInterval);
  pollState(); // Ä°lk Ã§aÄŸrÄ± hemen
  pollInterval = setInterval(pollState, 3000);
}

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load', () => {
  if (SERVER_URL) {
    document.getElementById('serverUrlDisplay').textContent = SERVER_URL;
    document.getElementById('serverUrlInput').value = SERVER_URL;
    startPolling();
  } else {
    document.getElementById('connStatus').className = 'conn-status wait';
    document.getElementById('connText').textContent = 'Kurulum sayfasÄ±ndan sunucu URL gir';
    goPage('setup');
    toast('Ã–nce sunucu URL\'ini gir ğŸ‘†', 'info');
  }
});
</script>

</body>
</html>
